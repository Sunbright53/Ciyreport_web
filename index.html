<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIY.CLUB Student Reports System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --ciy-blue:#173BA6; --ciy-yellow:#FFD200; --ciy-dark:#0A0F2C; }
    html,body{height:100%}
    html[lang="th"] body{font-family:'Noto Sans Thai',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    html[lang="en"] body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .bg-gradient-ciy{background:linear-gradient(180deg,#EBF4FF 0%,#FFFFFF 40%,#E6F0FF 100%)}
    .glass{background:rgba(255,255,255,0.85);backdrop-filter:blur(10px);border:1px solid rgba(14,165,233,0.18)}
    .btn-primary{background:#0ea5e9;color:#fff}.btn-primary:hover{filter:brightness(.95)}
    .btn-blue{background:#0369a1;color:#fff}.btn-blue:hover{filter:brightness(1.05)}
    .badge-green{background:#10B9811A;color:#10B981;border:1px solid #10B98155}
    .badge-red{background:#EF44441A;color:#EF4444;border:1px solid #EF444455}
    .badge-blue{background:#3B82F61A;color:#3B82F6;border:1px solid #3B82F655}
    .input{background:#fff;border:1.5px solid #93c5fd;color:#0f172a}
    .input:focus{outline:none;border-color:#0284c7;box-shadow:0 0 0 3px rgba(56,189,248,0.35)}
    .input::placeholder{color:#64748b;opacity:.85}
    .table-header{background:#e2e8f0}
    table thead th{color:#0f172a;font-weight:600}
    table thead th,table tbody td{border-bottom:1px solid #cbd5e1}
    table tbody td{color:#0f172a}
    .row-hover:hover{background:rgba(0,0,0,0.03)}
    .shadow-strong{box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    .modal-overlay{background:rgba(0,0,0,0.55)}
    .toast{animation:slideIn .4s ease}
    @keyframes slideIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .link{color:#0284c7}.link:hover{color:#0369a1;text-decoration:underline}
    .pill{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15)}
    .seg{border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.06)}
    .seg button.active{background:var(--ciy-yellow);color:#1a1a1a}
    .text-white\/50,.text-white\/60,.text-white\/70,.text-white\/80,.text-white{color:#0f172a!important}
    /* ===== All Reports Table Layout ===== */
    #student-reports-table {
  table-layout: fixed;
  width: 100%;
  margin: auto;
}

#student-reports-table th,
#student-reports-table td {
  text-align: center;      /* ‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
  vertical-align: middle;  /* ‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  padding: 12px 8px;
  word-break: break-word;  /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏î‡∏±‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
}
   #student-reports-table td.text-left-cell {
  text-align: left;       /* ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
  padding-left: 12px;     /* ‡∏°‡∏µ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ */
} 
    /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå */
    #student-reports-table th:nth-child(1){ width:5%; }  /* No */
    #student-reports-table th:nth-child(2){ width:14%; }  /* Date */
    #student-reports-table th:nth-child(3){ width:16%; }  /* Time */
    #student-reports-table th:nth-child(4){ width:12%; } /* Topic */
    #student-reports-table th:nth-child(5){ width:12%; } /* Session incharge */
    #student-reports-table th:nth-child(6){ width:16%; } /* Session type */
    #student-reports-table th:nth-child(7){ width:16%; } /* Session report */
    #student-reports-table th:nth-child(8){ width:16%; } /* Feedback */
    #student-reports-table th:nth-child(9){ width:16%; } /* Recommendation */
    #student-reports-table th:nth-child(10){ width:16%; } /* Link */

  </style>
</head>
<body class="bg-gradient-ciy text-sky-900">
  <div id="app" class="min-h-screen">
    <header class="sticky top-0 z-30 bg-white/70 backdrop-blur border-b border-sky-200">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://static.wixstatic.com/media/437090_cd922165d6ba4d568dde8680dff0b0df~mv2.png/v1/fill/w_249,h_63,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/437090_cd922165d6ba4d568dde8680dff0b0df~mv2.png" alt="CIY Logo" class="h-9 w-auto" onerror="this.src='';this.alt='Logo failed to load';this.style.display='none'">
        </div>
        <div id="top-actions" class="flex items-center gap-2">
          <button id="nav-home" class="px-3 py-2 rounded-lg hover:bg-white/10 transition">Home</button>
          <button id="nav-parent" class="px-3 py-2 rounded-lg hover:bg-white/10 transition">Parent</button>
          <button id="nav-coach" class="px-3 py-2 rounded-lg hover:bg-white/10 transition">Coach</button>
          <button id="toggle-lang" class="ml-1 px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-1" aria-label="Toggle language"><span class="flag-th">üáπüá≠</span><span class="flag-en">üá¨üáß</span></button>
          <div id="sessionBox" class="ml-2"></div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <div id="alert" class="hidden mb-4 p-3 rounded-lg border text-sm"></div>

      <!-- Landing -->
      <section id="view-landing" class="hidden">
        <div class="max-w-3xl mx-auto">
          <div class="glass rounded-2xl p-8 shadow-strong">
            <h1 id="landing-title" class="text-3xl md:text-4xl font-extrabold leading-tight text-sky-900">Welcome to CIY.CLUB Student Reports</h1>
            <p id="landing-desc" class="text-sky-700/80 mt-3">CIY.CLUB Student Progress Tracking System</p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <a id="landing-parent-btn" href="#/parent" class="btn-primary px-5 py-3 rounded-xl font-semibold text-center">Parent Login</a>
              <a id="landing-coach-btn" href="#/coach" class="btn-blue px-5 py-3 rounded-xl font-semibold text-center">Coach Login</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Parent -->
      <section id="view-parent" class="hidden">
        <div id="parent-login" class="glass rounded-2xl p-6 md:p-8 shadow-strong">
          <h2 id="parent-login-title" class="text-2xl font-bold">Parent Login</h2>
          <p id="parent-login-desc" class="text-white/70 mt-1 text-sm">Enter Coder ID and Parent Password</p>
          <form id="form-parent-login" class="mt-6 grid md:grid-cols-3 gap-4" autocomplete="off">
            <div class="md:col-span-1">
              <label id="label-coder-id" class="block text-sm mb-1">Coder ID</label>
              <input type="text" name="coder_id" required class="input w-full px-4 py-3 rounded-xl" placeholder="e.g., 6600001"/>
            </div>
            <div class="md:col-span-1">
              <label id="label-parent-pass" class="block text-sm mb-1">Parent Password</label>
              <input type="password" name="password" required class="input w-full px-4 py-3 rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
            </div>
            <div class="md:col-span-1 flex items-end">
              <button id="btn-parent-login" class="btn-primary w-full px-5 py-3 rounded-xl font-semibold">Log in</button>
            </div>
          </form>
        </div>

        <div id="parent-content" class="hidden mt-6 space-y-6">
          <div class="glass rounded-2xl p-6 shadow-strong" id="parent-profile"></div>
          <div class="glass rounded-2xl p-6 shadow-strong">
            <div class="flex items-center justify-between mb-4">
              <h3 id="parent-past-reports" class="text-xl font-bold">Past Reports</h3>
              <div class="text-sm text-white/60" id="report-count"></div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left border border-slate-300 rounded-xl overflow-hidden bg-white">
                <thead class="table-header">
                  <tr class="[&>th]:px-4 [&>th]:py-3">
                    <th id="th-date-1">Date</th>
                    <th id="th-course-1">Topic</th>
                    <th id="th-lesson-1">Lesson</th>
                    <th id="th-summary-1">Summary</th>
                    <th id="th-coach-1">Coach</th>
                    <th id="th-attach-1">Attachment</th>
                  </tr>
                </thead>
                <tbody id="parent-reports"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Coach -->
<section id="view-coach" class="hidden">

 <div id="coach-auth-guard" class="glass rounded-2xl p-6 md:p-8 shadow-strong hidden">
  <h2 id="coach-login-title" class="text-2xl font-bold">Coach Login</h2>
  <p id="coach-login-desc" class="text-white/70 mt-1 text-sm">
    Please sign in with your email and password.
  </p>

  <form id="form-coach-login" class="mt-5 grid sm:grid-cols-3 gap-3" autocomplete="off">
    <div class="sm:col-span-1">
      <label id="label-coach-email" class="block text-sm mb-1">Email</label>
      <input id="coach-email" name="email" type="email" required class="input w-full px-4 py-3 rounded-xl" placeholder="you@example.com">
    </div>
    <div class="sm:col-span-1">
      <label id="label-coach-pass" class="block text-sm mb-1">Password</label>
      <input id="coach-password" name="password" type="password" required class="input w-full px-4 py-3 rounded-xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div class="sm:col-span-1 flex items-end">
      <button id="btn-coach-login" class="btn-blue w-full px-5 py-3 rounded-xl font-semibold">Sign in</button>
    </div>
  </form>

  <div id="coach-login-hint" class="text-xs text-white/60 mt-3">
    Your account is verified via Apps Script (sheet ‚ÄúLogin‚Äù).
  </div>
</div>


  <div id="coach-content" class="hidden mt-6 space-y-6">
  <div class="glass rounded-2xl p-6 shadow-strong">
    <div class="flex flex-col md:flex-row md:items-center gap-3 justify-between">
      <h3 id="coach-all-students" class="text-xl font-bold">All Students</h3>
      <div class="flex items-center gap-2">
        <input id="coach-search" class="input px-4 py-2 rounded-xl" placeholder="Search: Coder ID / Nickname / Name" />
        <button id="coach-clear" class="px-3 py-2 rounded-lg hover:bg-white/10">Clear</button>
        <button id="btn-open-students" class="btn-blue px-3 py-2 rounded-lg font-semibold">Open Students</button>
        <button id="btn-open-reports" class="btn-blue px-3 py-2 rounded-lg font-semibold">Open Reports</button>
        <button id="btn-add-student" class="btn-primary px-3 py-2 rounded-lg font-semibold">+ Add Student</button>
      </div>
    </div>

    <div class="overflow-x-auto mt-4">
      <table class="w-full text-left border border-slate-300 rounded-xl bg-white">
        <thead class="table-header">
          <tr class="[&>th]:px-4 [&>th]:py-3">
            <th id="th-coderid">Coder ID</th>
            <th id="th-nickname">Nickname</th>
            <th id="th-fullname">Full name</th>
            <th id="th-status">Status</th>
            <th id="th-course">Course</th>
            <th id="th-parentpass">Parent Password</th>
          </tr>
        </thead>
        <tbody id="coach-students"></tbody>
      </table>
    </div>
  </div>
</div>
</section>

          

      <!-- Student Detail -->
      <section id="view-student" class="hidden">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mb-4">
          <div class="flex items-center gap-3">
            <button id="btn-back-coach" class="px-3 py-2 rounded-lg hover:bg-white/10">‚Üê Back</button>
            <h2 id="student-title" class="text-2xl font-bold">Student Detail</h2>
          </div>
          <div id="coach-actions" class="hidden">
            <button id="btn-add-report" class="btn-primary px-4 py-2 rounded-xl font-semibold">+ Add Report</button>
          </div>
        </div>

        <div id="student-profile" class="glass rounded-2xl p-6 shadow-strong mb-6"></div>

        <div class="glass rounded-2xl p-6 shadow-strong">
          <div class="flex items-center justify-between mb-4">
            <h3 id="student-all-reports" class="text-xl font-bold">All Reports</h3>
            <div class="text-sm text-white/60" id="student-report-count"></div>
          </div>
          <div class="overflow-x-auto">
           <table id="student-reports-table" class="w-full min-w-[1400px] text-left border border-slate-300 rounded-xl bg-white">
              <thead class="table-header">
                <tr class="[&>th]:px-4 [&>th]:py-3 [&>th]:text-center">
                  <th id="th-no-2">No</th>
                  <th id="th-date-2">Date</th>
                  <th id="th-time-2">Time</th>
                  <th id="th-topic-2">Topic</th>
                  <th id="th-incharge-2">Session incharge</th>
                  <th id="th-type-2">Session type</th>
                  <th id="th-report-2">Session report</th>
                  <th id="th-feedback-2">Feedback</th>
                  <th id="th-next-2">Recommendation for next session</th>
                  <th id="th-link-2">12 Times Progress Report (link)</th>
                </tr>
              </thead>
              <tbody id="student-reports"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: Add Report -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center z-40 modal-overlay">
    <div class="w-full max-w-2xl mx-4 glass rounded-2xl p-6 relative shadow-strong">
      <button id="modal-close" class="absolute top-3 right-3 px-3 py-1.5 rounded-lg hover:bg-white/10">‚úï</button>
      <h3 id="add-report-title" class="text-xl font-bold">Add Report</h3>
      <p id="modal-student" class="text-sm text-white/70 mt-1"></p>
      <form id="form-report" class="mt-5 grid md:grid-cols-2 gap-4">
        <div>
          <label id="lbl-date" class="block text-sm mb-1">Date</label>
          <input type="date" name="date" required class="input w-full px-4 py-3 rounded-xl"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Time</label>
          <input type="text" name="time" class="input w-full px-4 py-3 rounded-xl" placeholder="e.g., 09:00‚Äì10:00"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Topic</label>
          <input type="text" name="topic" required class="input w-full px-4 py-3 rounded-xl" placeholder="python / scratch ‚Ä¶"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Session incharge</label>
          <input type="text" name="session_incharge" required class="input w-full px-4 py-3 rounded-xl" placeholder="Coach name"/>
        </div>
        <div>
          <label class="block text-sm mb-1">Session type</label>
          <div>

  <select name="session_type" required class="input w-full px-4 py-3 rounded-xl">
    <option value="">-- Select Session Type --</option>
    <option value="Regular class">Regular class</option>
    <option value="Make-Up class">Make-Up class</option>
  </select>
</div>

        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Session report</label>
          <textarea name="session_report" required class="input w-full px-4 py-3 rounded-xl min-h-[80px]" placeholder="What was achieved?"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Feedback</label>
          <textarea name="feedback" class="input w-full px-4 py-3 rounded-xl min-h-[80px]" placeholder="-"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Recommendation for next session</label>
          <textarea name="next_recommend" class="input w-full px-4 py-3 rounded-xl min-h-[80px]" placeholder="Plan for next session"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">12 Times Progress Report (link) / Attachments</label>
          <input type="url" name="link12" class="input w-full px-4 py-3 rounded-xl" placeholder="https://..."/>
        </div>

        <!-- hidden legacy fields to keep backward-compat when posting -->
        <input type="hidden" name="course">
        <input type="hidden" name="lesson">
        <input type="hidden" name="progress_summary">
        <input type="hidden" name="skills">
        <input type="hidden" name="homework">
        <input type="hidden" name="next_plan">
        <input type="hidden" name="coach_name">
        <input type="hidden" name="attachments">

        <div class="md:col-span-2 flex items-center justify-end gap-3">
          <button type="button" id="btn-cancel-report" class="px-4 py-3 rounded-xl hover:bg-white/10">Cancel</button>
          <button id="btn-save-report" class="btn-primary px-5 py-3 rounded-xl font-semibold">Save report</button>
        </div>
      </form>
      <div id="modal-note" class="text-xs text-white/60 mt-3"></div>
    </div>
  </div>

  <!-- Modal: Add Student -->
  <div id="modal-add-student" class="fixed inset-0 hidden items-center justify-center z-40 modal-overlay">
    <div class="w-full max-w-xl mx-4 glass rounded-2xl p-6 relative shadow-strong">
      <button id="modal-addstudent-close" class="absolute top-3 right-3 px-3 py-1.5 rounded-lg hover:bg-white/10">‚úï</button>
      <h3 class="text-xl font-bold mb-1" id="add-student-title">Add Student</h3>
      <p class="text-sm text-white/70 mb-4" id="add-student-note">Fill student info below</p>

      <form id="form-add-student" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1" id="lbl-stu-coderid">Coder ID</label>
          <input type="text" name="coder_id" required class="input w-full px-4 py-3 rounded-xl" placeholder="‡πÄ‡∏ä‡πà‡∏ô 6600010"/>
        </div>
        <div>
          <label class="block text-sm mb-1" id="lbl-stu-nickname">Nickname</label>
          <input type="text" name="nickname" required class="input w-full px-4 py-3 rounded-xl" placeholder="‡πÄ‡∏ä‡πà‡∏ô Putter"/>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1" id="lbl-stu-fullname">Full name</label>
          <input type="text" name="fullname" required class="input w-full px-4 py-3 rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"/>
        </div>
        <div>
          <label class="block text-sm mb-1" id="lbl-stu-status">Status</label>
          <select name="status" class="input w-full px-4 py-3 rounded-xl" required>
            <option>Enrolled</option>
            <option>Not re-enrolled</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1" id="lbl-stu-course">Course</label>
          <input type="text" name="course_status" class="input w-full px-4 py-3 rounded-xl" placeholder="Rookie / Special" required/>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1" id="lbl-stu-program">Program (optional)</label>
          <input type="text" name="program" class="input w-full px-4 py-3 rounded-xl" placeholder="Python / Scratch / App Lab ..."/>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1" id="lbl-stu-parentpass">Parent Password</label>
          <input type="text" name="parent_password" class="input w-full px-4 py-3 rounded-xl" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ"/>
        </div>

        <div class="md:col-span-2 flex items-center justify-end gap-3 mt-2">
          <button type="button" id="btn-cancel-addstudent" class="px-4 py-3 rounded-xl hover:bg-white/10">Cancel</button>
          <button id="btn-save-student" class="btn-primary px-5 py-3 rounded-xl font-semibold">Save student</button>
        </div>
      </form>
      <div id="addstudent-hint" class="text-xs text-white/60 mt-3"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50"></div>

  <script>
    // CONFIG
    const CONFIG = {
  studentsCsv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT513ZZLUQp5zSHfkcfblFC5G0XrLUUJN6PBdfikUYr938X89Z_04AoN-yOXgczhd5kEdRzmDFjcB5E/pub?gid=0&single=true&output=csv",
  reportsCsv:  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT513ZZLUQp5zSHfkcfblFC5G0XrLUUJN6PBdfikUYr938X89Z_04AoN-yOXgczhd5kEdRzmDFjcB5E/pub?gid=1733230311&single=true&output=csv",
  sheetLinks: {
    students: "https://docs.google.com/spreadsheets/d/1TmQPVH-oM2B6PEam42h-bC0y5mc_Kgxry1EzwTZxkuE/edit?gid=0#gid=0",
    reports:  "https://docs.google.com/spreadsheets/d/1TmQPVH-oM2B6PEam42h-bC0y5mc_Kgxry1EzwTZxkuE/edit?gid=1733230311#gid=1733230311"
  },
  appScriptPostUrl: "https://script.google.com/macros/s/AKfycbwIbYdDOQ7R40qwK0uZA_OjsYDD3DQy1xMiDkQYAxgn1F-OCDN5yuSnbgUQCjSV3Mjk/exec",
  courseLinks: { rookie:'#', trainee:'#', special:'#' },   // üëà ‡πÉ‡∏™‡πà comma ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  auth: {
    webAppUrl: "https://script.google.com/macros/s/AKfycbz0krDgxFnYS5YHy-vT_uRLxfq7H5JXF1ybHDPMK96xWmANV2iLiW49ADPknXJePg-8/exec"
  }
};



    // STATE
    const state = {
      students: [],
      reports: [],
      loading: { students:false, reports:false },
      sort: { key:'coder_id', dir:'asc' },
      session: { role:null, parentId:null },
      lang: (sessionStorage.getItem('ciy_lang') || 'th'),
      programOptions: ["Python","JavaScript","Electronic Arduino (Blockly)","Robotics Arduino (Blockly)","Minecraft Edu (Blockly)","HTML/CSS/JavaScript","App (App Lab Blockly)","3D Printing (Tinkercad)","Scratch (coding)","Scratch (Game creation)"]
    };

    // HELPERS
    const $ = s => document.querySelector(s);
    const el = (t,a={},c=[])=>{const n=document.createElement(t);for(const[k,v]of Object.entries(a)){if(k==='class')n.className=v;else if(k==='html')n.innerHTML=v;else if(k.startsWith('on')&&typeof v==='function')n.addEventListener(k.slice(2),v);else n.setAttribute(k,v)};for(const x of (Array.isArray(c)?c:[c])) if(x!=null) n.append(x.nodeType?x:document.createTextNode(x));return n;};
    function showAlert(msg,type='info'){const box=$('#alert');const p={info:'bg-sky-50 border-sky-200 text-sky-700',success:'bg-emerald-50 border-emerald-200 text-emerald-700',error:'bg-rose-50 border-rose-200 text-rose-700',warn:'bg-amber-50 border-amber-200 text-amber-700'};box.className=`mb-4 p-3 rounded-lg border text-sm ${p[type]||p.info}`;box.textContent=msg;box.classList.remove('hidden');setTimeout(()=>box.classList.add('hidden'),4500)}
    function toast(msg,kind='success'){const t=$('#toast');const bg=kind==='success'?'bg-emerald-500':kind==='error'?'bg-rose-500':'bg-sky-500';const d=el('div',{class:`toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg mb-2`},msg);t.appendChild(d);setTimeout(()=>d.remove(),3000)}
    function parseCSV(text){const rows=[];let i=0,cur='',inQ=false,row=[];while(i<text.length){const ch=text[i];if(inQ){if(ch=='"'){if(text[i+1]=='"'){cur+='"';i++}else inQ=false}else cur+=ch}else{if(ch=='"')inQ=true;else if(ch==','){row.push(cur);cur=''}else if(ch=='\r'){}else if(ch=='\n'){row.push(cur);rows.push(row);cur='';row=[]}else cur+=ch}i++}if(cur.length||row.length){row.push(cur);rows.push(row)}const header=rows.shift()||[];return rows.map(r=>{const o={};header.forEach((h,idx)=>o[h.trim()]=(r[idx]??'').trim());return o})}
    function dateFromAny(s){if(!s)return null;const d=new Date(s);if(!isNaN(d))return d;const m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);if(m){const dd=+m[1],MM=+m[2]-1,yy=+m[3]<100?('20'+m[3]):+m[3];const dt=new Date(yy,MM,dd);if(!isNaN(dt))return dt}return null}
    function fmtDate(s){const d=dateFromAny(s);if(!d)return s||'-';return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+d.getFullYear()}

    function statusBadge(status){
  const lower = (status || '').toLowerCase().trim();
  const good = lower === 'enrolled';                // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Enrolled ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const bad  = lower === 'not re-enrolled';         // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Not re-enrolled
  const cls = good ? 'badge-green' : bad ? 'badge-red' : 'badge-blue';
  const label = status || (state.lang==='th' ? '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' : 'Unknown');
  return `<span class="text-xs px-2.5 py-1 rounded-full ${cls}">${label}</span>`;
}

    
    function loadingRow(c=6){return `<tr><td colspan="${c}" class="px-4 py-6 text-white/60">${state.lang==='th'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...':'Loading...'}</td></tr>`}
    function emptyRow(msg,c=6){return `<tr><td colspan="${c}" class="px-4 py-6 text-white/60">${msg}</td></tr>`}
    function linkOrDash(url){if(!url)return '-';const safe=url.startsWith('http')?url:null;return safe?`<a href="${safe}" target="_blank" rel="noopener noreferrer" class="link">${state.lang==='th'?'‡πÄ‡∏õ‡∏¥‡∏î':'Open'}</a>`:'-'}
    function shortCodeFor(s){const name=(s.nickname||'').replace(/[^A-Za-z‡∏Å-‡∏Æ‡∏∞-‡πå]/g,'').toUpperCase();const letters=(name+'XYZ').slice(0,3);const digits=((s.coder_id||'').match(/\d+/g)||['000']).join('').slice(-3)||'000';return letters+digits}
    function pick(obj, keys=[]){for(const k of keys){if(!k)continue;const v=(obj[k]??'').toString().trim();if(v) return v}return ''}


 // ===================== AUTH FUNCTIONS ===================== //

// ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÇ‡∏Ñ‡πâ‡∏ä‡∏î‡πâ‡∏ß‡∏¢ email + password ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà Apps Script
async function loginCoach(email, password){
  const base = (CONFIG.auth && CONFIG.auth.webAppUrl) || "";
  if (!base) return { ok:false, error:"Auth URL not set" };

  try {
    const res = await fetch(base, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        action: "login",
        email: email,
        password: password
      })
    });
    if (!res.ok) throw new Error("Login request failed");
    return await res.json();  // { ok:true/false, role:"coach"/null, email, error? }
  } catch (e) {
    console.warn("loginCoach error:", e);
    return { ok:false, error:e.message || "Login error" };
  }
}

// ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏Ñ‡πâ‡∏ä‡∏Å‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
async function handleCoachLogin(e){
  e.preventDefault();
  const form = e.target;
  const email = (form.email.value || '').trim();
  const password = (form.password.value || '').trim();
  if(!email || !password) return;

  try{
    const resp = await loginCoach(email, password);
    if(resp && resp.ok && resp.role === 'coach'){
      state.session = { role: 'coach', parentId: null };
      saveSession();
      toast(state.lang==='th' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Signed in', 'success');
      await renderCoach();
    } else {
      const msg = (resp && resp.error) ||
        (state.lang==='th' ? '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : 'Invalid email or password');
      showAlert(msg, 'error');
    }
  } catch(err){
    console.error(err);
    showAlert(state.lang==='th' ? '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : 'Login error', 'error');
  }
}


    
    // CSV fetch
    async function fetchCSV(url){const res=await fetch(url,{cache:'no-store'});if(!res.ok) throw new Error('Failed to load');return parseCSV(await res.text())}

    // Load Students
    async function loadStudents(){
      try{
        state.loading.students=true;
        const raw=await fetchCSV(CONFIG.studentsCsv);
        const map = {
          coder_id: ["No","Coder ID","ID","‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","coder_id","coder id"],
          nickname: ["Name","Nickname","Nick name","‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô"],
          fullname: ["Fullname","Full name","‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•","‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"],
          status: ["Status","‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞","Enrollment Status"],
          course_status: ["Status of course","Course","‡∏Ñ‡∏≠‡∏£‡πå‡∏™","course_status"],
          program: ["Program","‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°","‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
          parent_password: ["Parent Password","Parent pass","‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á"]
        };
        state.students = raw.map(r=>{
          const v=(keys)=>pick(r, keys);
          return {
            coder_id: v(map.coder_id),
            nickname: v(map.nickname),
            status: v(map.status),
            fullname: v(map.fullname),
            course_status: v(map.course_status),
            program: v(map.program),
            parent_password: v(map.parent_password) || '0000'
          };
        }).filter(s=>s.coder_id);
      } catch(e){ showAlert(state.lang==='th'?'‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î':'Error loading Students','error'); }
      finally{ state.loading.students=false; }
    }

    // Reports loader with flexible headers
    function rVal(row, candidates){
      for(const key of candidates){
        if (key in row && typeof row[key] !== 'undefined') {
          const v = (row[key] ?? '').toString().trim();
          if (v !== '') return v;
        }
      }
      return '';
    }
    async function loadReports(){
      try{
        state.loading.reports = true;
        const raw = await fetchCSV(CONFIG.reportsCsv);
        const H = {
          coder_id: ["coder_id","Coder ID","id","No","‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","coder id"],
          date: ["date","Date","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"],
          time: ["time","Time","‡πÄ‡∏ß‡∏•‡∏≤"],
          topic: ["topic","Topic","‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠","course","Course"],
          incharge: ["session incharge","Session incharge","session in-charge","incharge","coach","Coach","coach_name","Coach Name","‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô","‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏ö"],
          type: ["session type","Session type","class type","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≤‡∏ö"],
          report: ["session report","Session report","report","progress_summary","Progress Summary","summary","‡∏™‡∏£‡∏∏‡∏õ"],
          feedback: ["feedback","‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô","‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞","comment","‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå"],
          next_reco: ["Recommendation for next session","Recommendation for next session","next recommendation","next session plan","next_plan","Next Plan","‡πÅ‡∏ú‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"],
          link12: ["12 Times Progress Report (link)","12 times link","progress link","link","attachments","attachment","‡πÅ‡∏ô‡∏ö"],

          // legacy fallbacks
          course: ["course","Course","topic","Topic"],
          lesson: ["lesson","Lesson","‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"],
          progress_summary: ["progress_summary","summary","‡∏™‡∏£‡∏∏‡∏õ","Session report"],
          skills: ["skills","Skills","‡∏ó‡∏±‡∏Å‡∏©‡∏∞"],
          homework: ["homework","Homework","‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô"],
          next_plan: ["next_plan","Next Plan","‡πÅ‡∏ú‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ"],
          coach_name: ["coach_name","coach _name","coach name","coach","Coach Name"],
          attachments: ["attachments","attachment","‡πÅ‡∏ô‡∏ö","Attachment"]
        };

        state.reports = raw.map(r => ({
          coder_id: rVal(r, H.coder_id),
          date: rVal(r, H.date),
          time: rVal(r, H.time),
          topic: rVal(r, H.topic) || rVal(r, H.course),
          session_incharge: rVal(r, H.incharge) || rVal(r, H.coach_name),
          session_type: rVal(r, H.type) || rVal(r, H.course),
          session_report: rVal(r, H.report) || rVal(r, H.progress_summary),
          feedback: rVal(r, H.feedback),
          next_recommend: rVal(r, H.next_reco) || rVal(r, H.next_plan),
          link12: rVal(r, H.link12) || rVal(r, H.attachments),

          course: rVal(r, H.course),
          lesson: rVal(r, H.lesson),
          progress_summary: rVal(r, H.progress_summary),
          skills: rVal(r, H.skills),
          homework: rVal(r, H.homework),
          next_plan: rVal(r, H.next_plan),
          coach_name: rVal(r, H.coach_name),
          attachments: rVal(r, H.attachments)
        })).filter(x => x.coder_id);
      } catch(e){
        console.warn('Reports load failed:', e);
      } finally {
        state.loading.reports = false;
      }
    }

    // SESSION
    function saveSession(){sessionStorage.setItem('ciy_session',JSON.stringify(state.session));renderSessionBox()}
    function loadSession(){try{const s=JSON.parse(sessionStorage.getItem('ciy_session')||'{}');if(s&&(s.role==='coach'||s.role==='parent')) state.session=s;}catch{} renderSessionBox()}
    function renderSessionBox(){
      const box=$('#sessionBox'); box.innerHTML='';
      if(state.session.role){
        const roleLabel = state.session.role==='coach' ? (state.lang==='th'?'‡πÇ‡∏Ñ‡πâ‡∏ä':'Coach') : (state.lang==='th'?`‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á${state.session.parentId?' ¬∑ '+state.session.parentId:''}`:`Parent${state.session.parentId?' ¬∑ '+state.session.parentId:''}`);
        const pill=el('div',{class:'flex items-center gap-2'},[
          el('span',{class:'text-white/70 text-sm'},roleLabel),
          el('button',{class:'px-3 py-1.5 rounded-lg hover:bg-white/10',onclick:logout},state.lang==='th'?'‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö':'Logout')
        ]);
        box.appendChild(pill);
      }
    }

    // I18N
function setTextSafe(sel, text) {
  const node = document.querySelector(sel);
  if (node) node.textContent = text;
}

function applyLanguage(){
  const th = state.lang === 'th';
  document.documentElement.setAttribute('lang', th ? 'th' : 'en');
  // ‡πÉ‡∏ô applyLanguage()
setTextSafe('#coach-login-title', th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏ä' : 'Coach Login');
setTextSafe('#coach-login-desc',  th ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : 'Please sign in with your email and password.');
setTextSafe('#label-coach-email', th ? '‡∏≠‡∏µ‡πÄ‡∏°‡∏•' : 'Email');
setTextSafe('#label-coach-pass',  th ? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : 'Password');
setTextSafe('#btn-coach-login',   th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : 'Sign in');
document.getElementById('coach-email')?.setAttribute('placeholder', th?'you@example.com':'you@example.com');
document.getElementById('coach-password')?.setAttribute('placeholder', '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢');


  // Navbar
  setTextSafe('#nav-home', th ? '‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å' : 'Home');
  setTextSafe('#nav-parent', th ? '‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent');
  setTextSafe('#nav-coach', th ? '‡πÇ‡∏Ñ‡πâ‡∏ä' : 'Coach');

  // Landing
  setTextSafe('#landing-title', th ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô CIY' : 'Welcome to CIY.CLUB Student Reports');
  setTextSafe('#landing-desc', th ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô CIY.CLUB' : 'CIY.CLUB Student Progress Tracking System');
  setTextSafe('#landing-parent-btn', th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent Login');
  setTextSafe('#landing-coach-btn', th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏Ñ‡πâ‡∏ä' : 'Coach Login');

  // Parent
  setTextSafe('#parent-login-title', th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent Login');
  setTextSafe('#parent-login-desc', th ? '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Enter Coder ID and Parent Password');
  setTextSafe('#label-coder-id', th ? '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Coder ID)' : 'Coder ID');
  setTextSafe('#label-parent-pass', th ? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent Password');
  setTextSafe('#btn-parent-login', th ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : 'Log in');

  const coderInput = document.querySelector('#form-parent-login [name="coder_id"]');
  if (coderInput) coderInput.placeholder = th ? '‡πÄ‡∏ä‡πà‡∏ô 6600001' : 'e.g., 6600001';

  // Parent table
  setTextSafe('#parent-past-reports', th ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤' : 'Past Reports');
  setTextSafe('#th-date-1', th ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date');
  setTextSafe('#th-course-1', th ? '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠' : 'Topic');
  setTextSafe('#th-lesson-1', th ? '‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Lesson');
  setTextSafe('#th-summary-1', th ? '‡∏™‡∏£‡∏∏‡∏õ' : 'Summary');
  setTextSafe('#th-coach-1', th ? '‡πÇ‡∏Ñ‡πâ‡∏ä' : 'Coach');
  setTextSafe('#th-attach-1', th ? '‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö' : 'Attachment');

  // Coach section
  setTextSafe('#coach-all-students', th ? '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Students');
  const coachSearch = document.querySelector('#coach-search');
  if (coachSearch) coachSearch.placeholder = th ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: Coder ID / ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô / ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á' : 'Search: Coder ID / Nickname / Name';
  setTextSafe('#coach-clear', th ? '‡∏•‡πâ‡∏≤‡∏á' : 'Clear');
  setTextSafe('#btn-open-students', th ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏µ‡∏ï Students' : 'Open Students');
  setTextSafe('#btn-open-reports', th ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏µ‡∏ï Reports' : 'Open Reports');
  setTextSafe('#btn-add-student', th ? '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : '+ Add Student');
  setTextSafe('#th-coderid', 'Coder ID');
  setTextSafe('#th-nickname', th ? '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô' : 'Nickname');
  setTextSafe('#th-fullname', th ? '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' : 'Full name');
  setTextSafe('#th-status', th ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status');
  setTextSafe('#th-course', th ? '‡∏Ñ‡∏≠‡∏£‡πå‡∏™' : 'Course');
  setTextSafe('#th-parentpass', th ? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent Password');

  // Student detail
  setTextSafe('#btn-back-coach', th ? '‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö' : '‚Üê Back');
  setTextSafe('#student-title', th ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Student Detail');
  setTextSafe('#btn-add-report', th ? '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' : '+ Add Report');
  setTextSafe('#student-all-reports', th ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Reports');
  setTextSafe('#th-no-2', th ? '‡∏•‡∏≥‡∏î‡∏±‡∏ö' : 'No');
  setTextSafe('#th-date-2', th ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date');
  setTextSafe('#th-time-2', th ? '‡πÄ‡∏ß‡∏•‡∏≤' : 'Time');
  setTextSafe('#th-topic-2', th ? '‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠' : 'Topic');
  setTextSafe('#th-incharge-2', th ? '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Ñ‡∏≤‡∏ö' : 'Session incharge');
  setTextSafe('#th-type-2', th ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≤‡∏ö' : 'Session type');
  setTextSafe('#th-report-2', th ? '‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Session report');
  setTextSafe('#th-feedback-2', th ? '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞' : 'Feedback');
  setTextSafe('#th-next-2', th ? '‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : 'Recommendation for next session');
  setTextSafe('#th-link-2', th ? '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô 12 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' : '12 Times Progress Report (link)');

  // Flag opacity
  const tgl = document.getElementById('toggle-lang');
  if (tgl) {
    const isTH = th;
    tgl.querySelector('.flag-th').style.opacity = isTH ? '1' : '0.35';
    tgl.querySelector('.flag-en').style.opacity = isTH ? '0.35' : '1';
    tgl.querySelector('.flag-th').style.filter = isTH ? 'none' : 'grayscale(1)';
    tgl.querySelector('.flag-en').style.filter = isTH ? 'grayscale(1)' : 'none';
  }
}


    // RENDERERS
    function renderLanding(){showView('view-landing')}

    function renderParent(){
      showView('view-parent');
      const isLogged = state.session.role==='parent' && !!state.session.parentId;
      $('#parent-login').classList.toggle('hidden', isLogged);
      $('#parent-content').classList.toggle('hidden', !isLogged);
      if (!isLogged) return;
      const s = state.students.find(x=>x.coder_id===state.session.parentId);
      const profileBox = $('#parent-profile');
      if (!s){ profileBox.innerHTML=`<div class="text-white/70">Student not found</div>`; return; }
      profileBox.innerHTML = `
        <div class="flex gap-4">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center" style="background:#1a2a66;">
            <span class="text-2xl font-extrabold">${(s.nickname||'?').slice(0,1).toUpperCase()}</span>
          </div>
          <div class="flex-1">
            <div class="flex flex-wrap items-center gap-2">
              <div class="text-2xl font-bold">${s.nickname} <span class="text-white/50 font-medium">(${s.coder_id})</span></div>
              ${statusBadge(s.status)}
              <span class="text-xs px-2.5 py-1 rounded-full badge-blue">${s.course_status || 'N/A'}</span>
              <span class="text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/15 text-white/80">Code: ${shortCodeFor(s)}</span>
            </div>
            <div class="text-white/70 mt-1">${s.fullname || '-'}</div>
            <div class="mt-3 grid sm:grid-cols-2 gap-3">
              <div class="p-3 rounded-xl bg-white/5 border border-white/10">${state.lang==='th'?'‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°':'Program'}: <span class="font-semibold">${s.program || '-'}</span></div>
              <div class="p-3 rounded-xl bg-white/5 border border-white/10">${state.lang==='th'?'‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á':'Parent Password'}: <span class="font-semibold">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
            </div>
          </div>
        </div>
      `;
      const tbody=$('#parent-reports');
      tbody.innerHTML = state.loading.reports ? loadingRow(6) : '';
      const reports = state.reports.filter(r=>r.coder_id===s.coder_id).sort((a,b)=>dateFromAny(a.date)-dateFromAny(b.date));
      $('#report-count').textContent = `${reports.length} ${state.lang==='th'?'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'items'}`;
      if (!state.loading.reports && reports.length===0) tbody.innerHTML = emptyRow(state.lang==='th'?'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô':'No reports yet',6);
      else if (!state.loading.reports){
        tbody.innerHTML = reports.map(r=>`
          <tr class="row-hover">
            <td class="px-4 py-3">${fmtDate(r.date)}</td>
            <td class="px-4 py-3">${r.course || r.topic || '-'}</td>
            <td class="px-4 py-3">${r.lesson || '-'}</td>
            <td class="px-4 py-3 max-w-[420px]"><div class="line-clamp-2">${r.progress_summary || r.session_report || '-'}</div></td>
            <td class="px-4 py-3">${r.coach_name || r.session_incharge || '-'}</td>
            <td class="px-4 py-3">${linkOrDash(r.attachments || r.link12)}</td>
          </tr>
        `).join('');
      }
    }

    async function renderCoach(){
  showView('view-coach');

  const guard   = document.getElementById('coach-auth-guard');
  const content = document.getElementById('coach-content');
  if (content) content.classList.add('hidden');
  if (guard)   guard.classList.remove('hidden');

  // 1) ‡πÉ‡∏ä‡πâ local session ‡∏Å‡πà‡∏≠‡∏ô
  let authed = (state.session && state.session.role === 'coach');

  // 2) ‡∏ñ‡πâ‡∏≤ local ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà authed ‚Üí ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏±‡∏ö Apps Script
  if (!authed) {
    try {
      const auth = await checkCoachAuth();   // {ok, role, email?}
      authed = !!(auth && auth.ok && auth.role === 'coach');
    } catch (e) {
      console.warn('checkCoachAuth error:', e);
    }
  }

  if (!authed) {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° login
    state.session = { role: null, parentId: null };
    saveSession();
    const emailEl = document.getElementById('coach-email');
    if (emailEl) emailEl.focus();
    return;
  }

  // ‡∏ñ‡πâ‡∏≤ authed ‡πÅ‡∏•‡πâ‡∏ß
  state.session = { role: 'coach', parentId: null };
  saveSession();
  if (guard)   guard.classList.add('hidden');
  if (content) content.classList.remove('hidden');

  // ====== Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ======
  const searchEl = document.getElementById('coach-search');
  const q = (searchEl && searchEl.value || '').trim().toLowerCase();

  let list = state.students.slice();
  if (q){
    list = list.filter(s =>
      (s.coder_id||'').toLowerCase().includes(q) ||
      (s.nickname||'').toLowerCase().includes(q) ||
      (s.fullname||'').toLowerCase().includes(q) ||
      (s.program||'').toLowerCase().includes(q)
    );
  }

  const { key, dir } = state.sort;
  list.sort((a,b)=>{
    const av=(a[key]||'').toString().toLowerCase();
    const bv=(b[key]||'').toString().toLowerCase();
    if(av<bv) return dir==='asc' ? -1 : 1;
    if(av>bv) return dir==='asc' ?  1 : -1;
    return 0;
  });

  const tbody = document.getElementById('coach-students');
  if (!tbody) return;

  if (state.loading.students){
    tbody.innerHTML = loadingRow(6);
    return;
  }
  if (list.length===0){
    tbody.innerHTML = emptyRow(state.lang==='th'?'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤':'No matching students',6);
    return;
  }

  tbody.innerHTML = list.map(s=> `
    <tr class="row-hover cursor-pointer" data-id="${s.coder_id}">
      <td class="px-4 py-3">${s.coder_id}</td>
      <td class="px-4 py-3">
        <div>${s.nickname || '-'}</div>
        <div class="text-xs text-white/50 mt-0.5">Code: ${shortCodeFor(s)}</div>
      </td>
      <td class="px-4 py-3">${s.fullname || '-'}</td>
      <td class="px-4 py-3">${statusBadge(s.status)}</td>
      <td class="px-4 py-3">${s.course_status || '-'}</td>
      <td class="px-4 py-3">${
        s.parent_password
          ? `<span class="px-2 py-1 rounded-lg pill text-xs">${s.parent_password}</span>`
          : `<span class="text-xs text-red-300">${state.lang==='th'?'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á':'No parent pass'}</span>`
      }</td>
    </tr>
  `).join('');

  // ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ student
  Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
    tr.addEventListener('click',()=>{ 
      location.hash = `#/student/${tr.getAttribute('data-id')}`;
    });
  });

  // (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏™‡πà data-sort ‡∏à‡∏∞‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‚Äî‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°)
  document.querySelectorAll('thead th[data-sort]').forEach(th=>{
    th.onclick=()=>{
      const k=th.getAttribute('data-sort');
      if(state.sort.key===k) state.sort.dir = state.sort.dir==='asc' ? 'desc' : 'asc';
      else { state.sort.key=k; state.sort.dir='asc'; }
      renderCoach();
    };
  });
}


    // NEW: Render Student Detail (fixed & self-contained)
    function renderStudentDetail(id){
      showView('view-student');
      $('#coach-actions').classList.toggle('hidden', state.session.role!=='coach');
      $('#btn-back-coach').onclick = ()=> history.back();

      const s = state.students.find(x=> (x.coder_id||'').toLowerCase() === (id||'').toLowerCase());
      const profileBox = $('#student-profile');
      if(!s){ profileBox.innerHTML = `<div class="text-white/70">${state.lang==='th'?'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô':'Student not found'}</div>`; return; }

      profileBox.innerHTML = `
        <div class="flex gap-4 items-start">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center" style="background:#1a2a66;">
            <span class="text-2xl font-extrabold">${(s.nickname||'?').slice(0,1).toUpperCase()}</span>
          </div>
          <div class="flex-1">
            <div class="flex flex-wrap items-center gap-2">
              <div class="text-2xl font-bold">${s.nickname} <span class="text-white/50 font-medium">(${s.coder_id})</span></div>
              ${statusBadge(s.status)}
              <span class="text-xs px-2.5 py-1 rounded-full badge-blue">${s.course_status || 'N/A'}</span>
              <span class="text-xs px-2.5 py-1 rounded-full bg-white/10 border border-white/15 text-white/80">Code: ${shortCodeFor(s)}</span>
            </div>
            <div class="text-white/70 mt-1">${s.fullname || '-'}</div>
            <div class="mt-3 grid sm:grid-cols-3 gap-3">
              <div class="p-3 rounded-xl bg-white/5 border border-white/10">${state.lang==='th'?'‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°':'Program'}: <span class="font-semibold">${s.program || '-'}</span></div>
              <div class="p-3 rounded-xl bg-white/5 border border-white/10 flex items-center gap-2">
                <span>${state.lang==='th'?'‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á':'Parent Password'}:</span>
                <span id="ppass-val" data-val="${s.parent_password||''}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                <button id="ppass-toggle" class="px-2 py-1 rounded-lg hover:bg-white/10 text-sm">${state.lang==='th'?'‡πÅ‡∏™‡∏î‡∏á':'Show'}</button>
                <button id="ppass-copy" class="px-2 py-1 rounded-lg hover:bg-white/10 text-sm">${state.lang==='th'?'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å':'Copy'}</button>
              </div>
              <div class="p-3 rounded-xl bg-white/5 border border-white/10">${state.lang==='th'?'‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞':'Status'}: <span class="font-semibold">${s.status || '-'}</span></div>
            </div>
          </div>
        </div>
      `;

      // Bind show/hide/copy after DOM is in place
      if (state.session.role === 'coach') {
        const pVal = document.getElementById('ppass-val');
        const btnToggle = document.getElementById('ppass-toggle');
        const btnCopy = document.getElementById('ppass-copy');
        if (pVal && btnToggle) {
          let shown = false;
          btnToggle.addEventListener('click', () => {
            shown = !shown;
            pVal.textContent = shown ? (pVal.dataset.val || '') : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            btnToggle.textContent = shown
              ? (state.lang==='th' ? '‡∏ã‡πà‡∏≠‡∏ô' : 'Hide')
              : (state.lang==='th' ? '‡πÅ‡∏™‡∏î‡∏á' : 'Show');
          });
        }
        if (pVal && btnCopy) {
          btnCopy.addEventListener('click', async () => {
            try {
              await navigator.clipboard.writeText(pVal.dataset.val || '');
              toast(state.lang==='th' ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : 'Copied!', 'success');
            } catch {
              toast(state.lang==='th' ? '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : 'Copy failed', 'error');
            }
          });
        }
      }

            // Reports table
      const tbody=$('#student-reports');
      tbody.innerHTML = state.loading.reports ? loadingRow(10) : '';
      const rep = state.reports
        .filter(r => (r.coder_id||'').toLowerCase() === (s.coder_id||'').toLowerCase())
        .sort((a,b)=> (dateFromAny(a.date) - dateFromAny(b.date)));

      $('#student-report-count').textContent = `${rep.length} ${state.lang==='th'?'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£':'items'}`;

      if(!state.loading.reports && rep.length===0){
        tbody.innerHTML = emptyRow(state.lang==='th'?'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô':'No reports yet', 10);
      } else if(!state.loading.reports){
        tbody.innerHTML = rep.map((r,i)=>`
          <tr class="row-hover">
            <td class="px-4 py-3">${i+1}</td>
            <td class="px-4 py-3">${fmtDate(r.date)}</td>
            <td class="px-4 py-3">${r.time || '-'}</td>
            <td class="px-4 py-3">${r.topic || r.course || '-'}</td>
            <td class="px-4 py-3">${r.session_incharge || r.coach_name || '-'}</td>
            <td class="px-4 py-3">${r.session_type || '-'}</td>

            <!-- ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡∏≤‡∏ß -->
            <td class="px-4 py-3 max-w-[420px] text-left-cell"><div>${r.session_report || r.progress_summary || '--'}</div></td>
            <td class="px-4 py-3 max-w-[420px] text-left-cell"><div>${r.feedback || '--'}</div></td>
            <td class="px-4 py-3 max-w-[420px] text-left-cell"><div>${r.next_recommend || r.next_plan || '--'}</div></td>

            <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå (‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà 10 ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á) -->
            <td class="px-4 py-3">${linkOrDash(r.link12 || r.attachments)}</td>
          </tr>
        `).join('');
      }


      // Add report button
      $('#btn-add-report').onclick=()=>openReportModal(s);
    }

    // View control
    function showView(id){
      ['view-landing','view-parent','view-coach','view-student'].forEach(v=>document.getElementById(v).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    // Modal: Add Report
    function openReportModal(student){
      if(state.session.role!=='coach'){ showAlert(state.lang==='th'?'‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏ä‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô':'This feature is for coaches only','warn'); return; }
      $('#modal-student').textContent = `${state.lang==='th'?'‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö':'For'}: ${student.nickname} (${student.coder_id})`;
      const form=$('#form-report'); form.reset(); form.date.value=new Date().toISOString().slice(0,10); form.dataset.coder_id=student.coder_id;
      const isDemo=CONFIG.appScriptPostUrl.includes('REPLACE_WITH_YOUR_DEPLOYED_ID');
      $('#modal-note').innerHTML = isDemo ? (state.lang==='th'?'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡πÇ‡∏°':'Note: App Script URL not set yet. This is a demo save.') : (state.lang==='th'?'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô':'Data will be sent to Google Apps Script and appended to the Reports sheet.');
      $('#modal').classList.remove('hidden'); $('#modal').classList.add('flex');
    }
    function closeModal(){ $('#modal').classList.add('hidden'); $('#modal').classList.remove('flex'); }

    async function submitReport(e){
      e.preventDefault();
      const form = e.target;
      const coder_id = form.dataset.coder_id;

      // new schema
      const newPayload = {
        action: 'add_report',
        coder_id,
        date: (form.date.value||'').trim(),
        time: (form.time.value||'').trim(),
        topic: (form.topic.value||'').trim(),
        session_incharge: (form.session_incharge.value||'').trim(),
        session_type: (form.session_type.value||'').trim(),
        session_report: (form.session_report.value||'').trim(),
        feedback: (form.feedback.value||'').trim(),
        next_recommend: (form.next_recommend.value||'').trim(),
        link12: (form.link12.value||'').trim()
      };

      // legacy mapping
      const legacy = {
        course: newPayload.topic,
        lesson: '',
        progress_summary: newPayload.session_report,
        skills: '',
        homework: '',
        next_plan: newPayload.next_recommend,
        coach_name: newPayload.session_incharge,
        attachments: newPayload.link12
      };

      const payload = { ...newPayload, ...legacy };
      const isDemo = CONFIG.appScriptPostUrl.includes('REPLACE_WITH_YOUR_DEPLOYED_ID');

      try{
        if(isDemo){
          state.reports.unshift({ ...payload });
          toast(state.lang==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏î‡πÇ‡∏°)':'Saved (demo)', 'success');
        }else{
          const body = new URLSearchParams();
          Object.entries(payload).forEach(([k,v])=> body.append(k, v ?? ''));
          const res = await fetch(CONFIG.appScriptPostUrl, { method:'POST', body });
          if(!res.ok) throw new Error('Save failed');
          toast(state.lang==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!':'Saved!','success');
          await loadReports();
        }
        closeModal();
        const m=(location.hash||'').match(/^#\/student\/(.+)$/);
        if(m) renderStudentDetail(m[1]);
      }catch(err){
        console.error(err);
        toast(state.lang==='th'?'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å':'Error saving','error');
      }
    }

    // Add Student modal helpers
    function randomPass(len=6){
      const chars='abcdefghijklmnopqrstuvwxyz0123456789';
      let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function openAddStudentModal(){
      if(state.session.role!=='coach'){
        showAlert(state.lang==='th'?'‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏ä‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô':'This feature is for coaches only','warn');
        return;
      }
      const th = state.lang==='th';
      $('#add-student-title').textContent = th? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà' : 'Add Student';
      $('#add-student-note').textContent = th? '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á' : 'Fill student info below';
      $('#lbl-stu-coderid').textContent = th? '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Coder ID)' : 'Coder ID';
      $('#lbl-stu-nickname').textContent = th? '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô' : 'Nickname';
      $('#lbl-stu-fullname').textContent = th? '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•' : 'Full name';
      $('#lbl-stu-status').textContent = th? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status';
      $('#lbl-stu-course').textContent = th? '‡∏Ñ‡∏≠‡∏£‡πå‡∏™' : 'Course';
      $('#lbl-stu-program').textContent = th? '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)' : 'Program (optional)';
      $('#lbl-stu-parentpass').textContent = th? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á' : 'Parent Password';
      $('#btn-save-student').textContent = th? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Save student';
      $('#btn-cancel-addstudent').textContent = th? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel';

      const f = $('#form-add-student');
      f.reset();
      f.parent_password.value = randomPass();

      const isDemo = CONFIG.appScriptPostUrl.includes('REPLACE_WITH_YOUR_DEPLOYED_ID');
      $('#addstudent-hint').innerHTML = isDemo
        ? (th? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script ‚Äî ‡πÄ‡∏î‡πÇ‡∏°‡πÇ‡∏´‡∏°‡∏î (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á)': 'Note: App Script URL not set yet ‚Äî demo mode (won‚Äôt write to real sheet)')
        : (th? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ä‡∏µ‡∏ï Students' : 'Data will be sent to Apps Script and appended to Students sheet');

      const m = $('#modal-add-student');
      m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeAddStudentModal(){
      const m = $('#modal-add-student');
      m.classList.add('hidden'); m.classList.remove('flex');
    }
    async function submitAddStudent(e){
      e.preventDefault();
      const f = e.target;
      const payload = {
        action: 'add_student',
        coder_id: (f.coder_id.value||'').trim(),
        nickname: (f.nickname.value||'').trim(),
        fullname: (f.fullname.value||'').trim(),
        status: (f.status.value||'').trim(),
        course_status: (f.course_status.value||'').trim(),
        program: (f.program.value||'').trim(),
        parent_password: (f.parent_password.value||'').trim() || randomPass()
      };

      if(!payload.coder_id){ showAlert(state.lang==='th'?'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô':'Please provide Coder ID','warn'); return; }

      if(state.students.some(s => (s.coder_id||'').toLowerCase() === payload.coder_id.toLowerCase())){
        showAlert(state.lang==='th'?'‡∏°‡∏µ Coder ID ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß':'This Coder ID already exists','error');
        return;
      }

      const isDemo = CONFIG.appScriptPostUrl.includes('REPLACE_WITH_YOUR_DEPLOYED_ID');
      try{
        if(isDemo){
          state.students.unshift({...payload});
          toast(state.lang==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏î‡πÇ‡∏°) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à':'Student saved (demo)', 'success');
        }else{
          const body = new URLSearchParams();
          Object.entries(payload).forEach(([k,v])=>body.append(k,v));
          const res = await fetch(CONFIG.appScriptPostUrl, { method:'POST', body });
          if(!res.ok) throw new Error('Save failed');

          toast(state.lang==='th'?'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!':'Student saved!', 'success');
          await loadStudents();
        }
        closeAddStudentModal();
        if((location.hash||'').startsWith('#/coach')) renderCoach();
      }catch(err){
        console.error(err);
        toast(state.lang==='th'?'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô':'Error adding student','error');
      }
    }
// ===== AUTH via Apps Script =====
async function checkCoachAuth() {
  const base = (CONFIG.auth && CONFIG.auth.webAppUrl) || "";
  if (!base || base.includes("YOUR_WEB_APP_URL")) {
    console.warn("Apps Script auth URL not set yet.");
    return { ok: false, role: null, email: null };
  }
  try {
    const url = base + "?action=whoami";
    const res = await fetch(url, { credentials: "include", cache: "no-store" });
    if (!res.ok) throw new Error("Auth check failed");
    const data = await res.json(); // { ok:true/false, role:"coach"/null, email:"..." }
    return data;
  } catch (e) {
    console.warn("checkCoachAuth error:", e);
    return { ok: false, role: null, email: null };
  }
}

function openCoachSignin() {
  const base = (CONFIG.auth && CONFIG.auth.webAppUrl) || "";
  if (!base || base.includes("YOUR_WEB_APP_URL")) {
    showAlert(
      state.lang === 'th'
        ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Apps Script Web App URL ‡πÉ‡∏ô CONFIG.auth.webAppUrl'
        : 'Apps Script Web App URL is not set in CONFIG.auth.webAppUrl',
      'warn'
    );
    return;
  }
  window.open(base + "?action=login", "_blank", "noopener");
}
async function coachSignOut() {
  const base = (CONFIG.auth && CONFIG.auth.webAppUrl) || "";
  if (!base) return;
  try {
    await fetch(base + "?action=logout", { credentials: "include" });
  } catch (e) {
    console.warn("coachSignOut error:", e);
  }
}

async function logout(){
  await coachSignOut(); // ‡∏ï‡∏±‡∏î session ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏î‡πâ‡∏ß‡∏¢
  state.session = { role:null, parentId:null };
  saveSession();
  location.hash = '#/';
}


    // Router
    // Router
async function router(){
  const hash = location.hash || "#/";
  if(hash==="#/" || hash==="#"){ 
    renderLanding(); 
  }
  else if(hash.startsWith('#/parent')){
    if (state.session.role==='parent' && state.session.parentId){
      location.hash = `#/student/${state.session.parentId}`;
    } else {
      renderParent();
    }
  }
  else if(hash.startsWith('#/coach')){
    await renderCoach(); // ‚úÖ ‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô
  }
  else if(hash.startsWith('#/student/')){
    const m = hash.match(/^#\/student\/(.+)$/);
    if(m) renderStudentDetail(m[1]); else renderLanding();
  }
  else renderLanding();
}


    // Events
   function bindEvents(){
  $('#nav-home').onclick=()=>location.hash='#/';
  $('#nav-parent').onclick=()=>location.hash='#/parent';
  $('#nav-coach').onclick=()=>location.hash='#/coach';

  const toggleBtn=document.getElementById('toggle-lang');
  if(toggleBtn) toggleBtn.onclick=()=>{
    state.lang=state.lang==='th'?'en':'th';
    sessionStorage.setItem('ciy_lang',state.lang);
    applyLanguage(); router();
  };
  const tgl=document.getElementById('toggle-lang'); 
  if(tgl){
    const isTH=state.lang==='th'; 
    tgl.querySelector('.flag-th').style.opacity=isTH?'1':'0.35'; 
    tgl.querySelector('.flag-en').style.opacity=isTH?'0.35':'1'; 
    tgl.querySelector('.flag-th').style.filter=isTH?'none':'grayscale(1)'; 
    tgl.querySelector('.flag-en').style.filter=isTH?'grayscale(1)':'none';
  }

  // Parent login
  const formParent = document.getElementById('form-parent-login');
  if(formParent) formParent.addEventListener('submit',handleParentLogin);

  // Coach login (‡πÉ‡∏´‡∏°‡πà: email+password)
  const formCoach = document.getElementById('form-coach-login');
  if(formCoach) formCoach.addEventListener('submit',handleCoachLogin);

  // Coach search/clear
  const coachSearch = document.getElementById('coach-search');
  if(coachSearch) coachSearch.addEventListener('input',()=>renderCoach());
  const coachClear = document.getElementById('coach-clear');
  if(coachClear) coachClear.addEventListener('click',()=>{
    if(coachSearch) coachSearch.value='';
    renderCoach();
  });

  // Open Sheets
  const openSheet=(type)=>{
    const links=CONFIG.sheetLinks||{};
    const url=type==='students'?links.students:links.reports;
    if(!url){
      toast(state.lang==='th'?'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ä‡∏µ‡∏ï':'Sheet link not set','error');
      return;
    }
    window.open(url,'_blank');
  };
  const btnOpenStudents = document.getElementById('btn-open-students');
  if(btnOpenStudents) btnOpenStudents.onclick=()=>openSheet('students');
  const btnOpenReports = document.getElementById('btn-open-reports');
  if(btnOpenReports) btnOpenReports.onclick=()=>openSheet('reports');

  // Report modal
  const btnModalClose = document.getElementById('modal-close');
  if(btnModalClose) btnModalClose.onclick=closeModal;
  const btnCancelReport = document.getElementById('btn-cancel-report');
  if(btnCancelReport) btnCancelReport.onclick=closeModal;
  const formReport = document.getElementById('form-report');
  if(formReport) formReport.addEventListener('submit',submitReport);

  // Add Student modal
  const btnAddStu = document.getElementById('btn-add-student');
  if(btnAddStu) btnAddStu.onclick = openAddStudentModal;
  const btnCloseAddStu = document.getElementById('modal-addstudent-close');
  if(btnCloseAddStu) btnCloseAddStu.onclick = closeAddStudentModal;
  const btnCancelAddStu = document.getElementById('btn-cancel-addstudent');
  if(btnCancelAddStu) btnCancelAddStu.onclick = closeAddStudentModal;
  const formAddStu = document.getElementById('form-add-student');
  if(formAddStu) formAddStu.addEventListener('submit', submitAddStudent);

  window.addEventListener('hashchange',router);

}


    // Auth handlers
    async function handleParentLogin(e){
      e.preventDefault();
      const fd=new FormData(e.target);
      const coder_id=(fd.get('coder_id')||'').toString().trim();
      const password=(fd.get('password')||'').toString().trim();
      if(!coder_id||!password) return;
      if(state.loading.students){showAlert(state.lang==='th'?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á':'Students are still loading, please try again','warn');return;}
      const s=state.students.find(x=>(x.coder_id||'').toLowerCase()===coder_id.toLowerCase());
      if(!s){showAlert(state.lang==='th'?'‡πÑ‡∏°‡πà‡∏û‡∏ö Coder ID':'Coder ID not found','error');return;}
      if(String(s.parent_password).trim()!==password){showAlert(state.lang==='th'?'‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á':'Incorrect parent password','error');return;}
      state.session = { role:'parent', parentId:s.coder_id };
      saveSession();
      location.hash = `#/student/${s.coder_id}`;

    }
  

    // Start
    async function start(){
      loadSession();
      bindEvents();
      await Promise.all([loadStudents(), loadReports()]);
      applyLanguage();
      router();
    }
    start();
  </script>
</body>
</html>
